<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Macro Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 500px;
      margin: auto;
      font-size: 18px;
    }

    input, button {
      font-size: 18px;
      margin: 6px 0;
      width: 100%;
      padding: 10px;
    }

    .hydration-buttons button {
      width: 30%;
      margin: 5px 1%;
      padding: 10px;
      font-size: 18px;
    }

    hr {
      margin: 20px 0;
    }

    .bottom-buffer {
      height: 200px;
    }

    #addButton.disabled {
      background-color: #ccc;
      color: #666;
    }

    .weight-display {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }

    .trend-positive {
      color: #d9534f;
    }

    .trend-negative {
      color: #5cb85c;
    }

    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      overflow: auto;
    }

    .modal-content {
      background-color: #fff;
      margin: 5% auto;
      padding: 20px;
      width: 90%;
      max-width: 600px;
      border-radius: 8px;
      position: relative;
    }

    .close-button {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      color: #aaa;
    }

    .close-button:hover {
      color: #000;
    }

    #weightCanvas {
      width: 100%;
      border: 1px solid #ddd;
      margin: 15px 0;
    }

    .graph-stats {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
    }
  </style>
</head>

<body>

  <h2>Macro Tracker</h2>

  <!-- Reset Buttons -->
  <button onclick="confirmResetTotals()">Reset Totals</button>
  <button onclick="confirmResetEverything()">Reset Everything</button>

  <hr>

  <!-- Medication Button -->
  <button onclick="recordMeds()">Took Meds</button>
  <div id="medsTimestamp" style="margin-top: 5px; font-size: 16px; color: #444;"></div>

  <hr>

  <h3>Set Daily Targets</h3>
  Calories: <input type="number" id="targetCalories">
  Protein (g): <input type="number" id="targetProtein">
  Carbs (g): <input type="number" id="targetCarbs">
  Fat (g): <input type="number" id="targetFat">
  Hydration (oz): <input type="number" id="targetHydration">

  <button onclick="setTargets()">Set Targets</button>

  <hr>

  <h3>Today's Intake</h3>
  <div id="totalsDisplay"></div>

  <hr>

  <h3>Weight Log</h3>
  Today's Weight (lbs): <input type="number" step="0.1" id="todayWeight">
  <button onclick="logWeight()">Log Weight</button>
  <div class="weight-display" id="weightDisplay"></div>
  <button onclick="showWeightTrend()">View Trend Graph</button>

  <hr>

  <h3>Add Intake</h3>
  Calories: <input type="number" id="addCalories">
  Protein: <input type="number" id="addProtein">
  Carbs: <input type="number" id="addCarbs">
  Fat: <input type="number" id="addFat">

  <button id="addButton" onclick="addIntake()">Add</button>

  <hr>

  <h3>Hydration</h3>
  <div class="hydration-buttons">
    <button onclick="addHydration(8)">8 oz</button>
    <button onclick="addHydration(12)">12 oz</button>
    <button onclick="addHydration(16)">16 oz</button>
    <button onclick="addHydration(18)">18 oz</button>
    <button onclick="addHydration(20)">20 oz</button>
  </div>

  <div class="bottom-buffer"></div>

  <!-- Modal for weight trend graph -->
  <div id="weightModal" class="modal" onclick="closeModalOnOutsideClick(event)">
    <div class="modal-content">
      <span class="close-button" onclick="closeWeightModal()">&times;</span>
      <h3>Weight Trend</h3>
      <canvas id="weightCanvas" width="560" height="300"></canvas>
      <div class="graph-stats" id="graphStats"></div>
    </div>
  </div>

  <script>
    let totals = { calories: 0, protein: 0, carbs: 0, fat: 0, hydration: 0 };
    let targets = { calories: "", protein: "", carbs: "", fat: "", hydration: "" };
    let medsTimestamp = "";
    let weightLog = {};

    function loadData() {
      const savedTotals = localStorage.getItem("macroTotals");
      const savedTargets = localStorage.getItem("macroTargets");
      const savedMeds = localStorage.getItem("medsTimestamp");
      const savedWeights = localStorage.getItem("weightLog");

      if (savedTotals) totals = JSON.parse(savedTotals);
      if (savedTargets) targets = JSON.parse(savedTargets);
      if (savedMeds) medsTimestamp = savedMeds;
      if (savedWeights) weightLog = JSON.parse(savedWeights);

      document.getElementById("targetCalories").value = targets.calories || "";
      document.getElementById("targetProtein").value = targets.protein || "";
      document.getElementById("targetCarbs").value = targets.carbs || "";
      document.getElementById("targetFat").value = targets.fat || "";
      document.getElementById("targetHydration").value = targets.hydration || "";

      document.getElementById("medsTimestamp").innerText =
        medsTimestamp ? `Last taken: ${medsTimestamp}` : "";

      // Load today's weight if exists
      const today = getTodayDate();
      if (weightLog[today]) {
        document.getElementById("todayWeight").value = weightLog[today];
      }

      updateDisplay();
      updateWeightDisplay();
    }

    function saveTotals() {
      localStorage.setItem("macroTotals", JSON.stringify(totals));
    }

    function saveWeightLog() {
      // Keep only last 30 days to avoid bloat
      const dates = Object.keys(weightLog).sort();
      if (dates.length > 30) {
        const toKeep = dates.slice(-30);
        const newLog = {};
        toKeep.forEach(date => newLog[date] = weightLog[date]);
        weightLog = newLog;
      }
      localStorage.setItem("weightLog", JSON.stringify(weightLog));
    }

    function getTodayDate() {
      const now = new Date();
      return now.toISOString().split('T')[0]; // YYYY-MM-DD
    }

    function setTargets() {
      targets.calories = document.getElementById("targetCalories").value;
      targets.protein = document.getElementById("targetProtein").value;
      targets.carbs = document.getElementById("targetCarbs").value;
      targets.fat = document.getElementById("targetFat").value;
      targets.hydration = document.getElementById("targetHydration").value;

      localStorage.setItem("macroTargets", JSON.stringify(targets));
      updateDisplay();
    }

    function updateDisplay() {
      document.getElementById("totalsDisplay").innerHTML = `
        Calories: ${totals.calories} / ${targets.calories || "—"}<br>
        Protein: ${totals.protein}g / ${targets.protein || "—"}g<br>
        Carbs: ${totals.carbs}g / ${targets.carbs || "—"}g<br>
        Fat: ${totals.fat}g / ${targets.fat || "—"}g<br>
        Hydration: ${totals.hydration} oz / ${targets.hydration || "—"} oz
      `;
    }

    function logWeight() {
      const weight = parseFloat(document.getElementById("todayWeight").value);
      if (!weight || weight <= 0) {
        alert("Please enter a valid weight");
        return;
      }

      const today = getTodayDate();
      weightLog[today] = weight;
      saveWeightLog();
      updateWeightDisplay();
    }

    function updateWeightDisplay() {
      const today = getTodayDate();
      const todayWeight = weightLog[today];

      let displayHTML = "";

      if (todayWeight) {
        displayHTML += `<strong>Today:</strong> ${todayWeight} lbs<br>`;
      } else {
        displayHTML += `<em>No weight logged today</em><br>`;
      }

      // Calculate 7-day average (current week)
      const dates = Object.keys(weightLog).sort();
      const last7 = dates.slice(-7);
      
      if (last7.length > 0) {
        const last7Weights = last7.map(date => weightLog[date]);
        const avg7 = (last7Weights.reduce((a, b) => a + b, 0) / last7Weights.length).toFixed(1);
        displayHTML += `<strong>7-Day Average:</strong> ${avg7} lbs<br>`;

        // Calculate previous 7-day average for comparison
        if (dates.length >= 14) {
          const prev7 = dates.slice(-14, -7);
          const prev7Weights = prev7.map(date => weightLog[date]);
          const avgPrev7 = (prev7Weights.reduce((a, b) => a + b, 0) / prev7Weights.length).toFixed(1);
          
          const trend = (avg7 - avgPrev7).toFixed(1);
          const trendClass = trend > 0 ? "trend-positive" : "trend-negative";
          const trendSymbol = trend > 0 ? "+" : "";
          
          displayHTML += `<strong>Previous Week:</strong> ${avgPrev7} lbs<br>`;
          displayHTML += `<strong>Week-over-Week:</strong> <span class="${trendClass}">${trendSymbol}${trend} lbs</span>`;
        }
      }

      document.getElementById("weightDisplay").innerHTML = displayHTML || "<em>Start logging weight to see trends</em>";
    }

    function showWeightTrend() {
      const dates = Object.keys(weightLog).sort();
      
      if (dates.length < 2) {
        alert("Need at least 2 weight entries to show trend");
        return;
      }

      const modal = document.getElementById("weightModal");
      modal.style.display = "block";

      drawWeightGraph(dates);
      updateGraphStats(dates);
    }

    function drawWeightGraph(dates) {
      const canvas = document.getElementById("weightCanvas");
      const ctx = canvas.getContext("2d");
      const width = canvas.width;
      const height = canvas.height;
      
      // Clear canvas
      ctx.clearRect(0, 0, width, height);

      // Get weight data
      const weights = dates.map(date => weightLog[date]);
      const minWeight = Math.min(...weights) - 2;
      const maxWeight = Math.max(...weights) + 2;
      const weightRange = maxWeight - minWeight;

      // Calculate 7-day rolling average
      const rollingAvg = [];
      for (let i = 0; i < dates.length; i++) {
        const start = Math.max(0, i - 6);
        const windowWeights = weights.slice(start, i + 1);
        const avg = windowWeights.reduce((a, b) => a + b, 0) / windowWeights.length;
        rollingAvg.push(avg);
      }

      // Padding
      const padding = { top: 20, right: 30, bottom: 40, left: 50 };
      const graphWidth = width - padding.left - padding.right;
      const graphHeight = height - padding.top - padding.bottom;

      // Draw axes
      ctx.strokeStyle = "#333";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(padding.left, padding.top);
      ctx.lineTo(padding.left, height - padding.bottom);
      ctx.lineTo(width - padding.right, height - padding.bottom);
      ctx.stroke();

      // Draw weight grid lines and labels
      const numYTicks = 5;
      ctx.strokeStyle = "#ddd";
      ctx.fillStyle = "#666";
      ctx.font = "12px sans-serif";
      ctx.textAlign = "right";

      for (let i = 0; i <= numYTicks; i++) {
        const weight = minWeight + (weightRange * i / numYTicks);
        const y = height - padding.bottom - (graphHeight * i / numYTicks);
        
        ctx.beginPath();
        ctx.moveTo(padding.left, y);
        ctx.lineTo(width - padding.right, y);
        ctx.stroke();
        
        ctx.fillText(weight.toFixed(0), padding.left - 5, y + 4);
      }

      // Draw date labels (show every few dates to avoid crowding)
      ctx.textAlign = "center";
      const dateStep = Math.max(1, Math.floor(dates.length / 6));
      
      for (let i = 0; i < dates.length; i += dateStep) {
        const x = padding.left + (graphWidth * i / (dates.length - 1));
        const dateStr = new Date(dates[i]).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        ctx.fillText(dateStr, x, height - padding.bottom + 20);
      }

      // Draw daily weight line
      ctx.strokeStyle = "#4CAF50";
      ctx.lineWidth = 2;
      ctx.beginPath();
      
      for (let i = 0; i < weights.length; i++) {
        const x = padding.left + (graphWidth * i / (dates.length - 1));
        const y = height - padding.bottom - ((weights[i] - minWeight) / weightRange * graphHeight);
        
        if (i === 0) {
          ctx.moveTo(x, y);
        } else {
          ctx.lineTo(x, y);
        }
      }
      ctx.stroke();

      // Draw daily weight points
      ctx.fillStyle = "#4CAF50";
      for (let i = 0; i < weights.length; i++) {
        const x = padding.left + (graphWidth * i / (dates.length - 1));
        const y = height - padding.bottom - ((weights[i] - minWeight) / weightRange * graphHeight);
        
        ctx.beginPath();
        ctx.arc(x, y, 3, 0, 2 * Math.PI);
        ctx.fill();
      }

      // Draw 7-day rolling average line
      if (rollingAvg.length >= 7) {
        ctx.strokeStyle = "#2196F3";
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        
        for (let i = 0; i < rollingAvg.length; i++) {
          const x = padding.left + (graphWidth * i / (dates.length - 1));
          const y = height - padding.bottom - ((rollingAvg[i] - minWeight) / weightRange * graphHeight);
          
          if (i === 0) {
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
          }
        }
        ctx.stroke();
        ctx.setLineDash([]);
      }

      // Legend
      ctx.font = "14px sans-serif";
      ctx.textAlign = "left";
      
      ctx.fillStyle = "#4CAF50";
      ctx.fillRect(padding.left, 5, 15, 3);
      ctx.fillStyle = "#333";
      ctx.fillText("Daily Weight", padding.left + 20, 10);
      
      if (rollingAvg.length >= 7) {
        ctx.fillStyle = "#2196F3";
        ctx.fillRect(padding.left + 130, 5, 15, 3);
        ctx.fillStyle = "#333";
        ctx.fillText("7-Day Average", padding.left + 150, 10);
      }
    }

    function updateGraphStats(dates) {
      const weights = dates.map(date => weightLog[date]);
      const startWeight = weights[0];
      const endWeight = weights[weights.length - 1];
      const totalChange = (endWeight - startWeight).toFixed(1);
      const changeSymbol = totalChange > 0 ? "+" : "";
      const changeClass = totalChange > 0 ? "trend-positive" : "trend-negative";

      const last7 = dates.slice(-7);
      const last7Weights = last7.map(date => weightLog[date]);
      const avg7 = (last7Weights.reduce((a, b) => a + b, 0) / last7Weights.length).toFixed(1);

      let statsHTML = `
        <strong>Total Period:</strong> ${dates.length} days<br>
        <strong>Start:</strong> ${startWeight} lbs → <strong>Current:</strong> ${endWeight} lbs<br>
        <strong>Total Change:</strong> <span class="${changeClass}">${changeSymbol}${totalChange} lbs</span><br>
        <strong>7-Day Average:</strong> ${avg7} lbs
      `;

      if (dates.length >= 14) {
        const prev7 = dates.slice(-14, -7);
        const prev7Weights = prev7.map(date => weightLog[date]);
        const avgPrev7 = (prev7Weights.reduce((a, b) => a + b, 0) / prev7Weights.length).toFixed(1);
        const weekTrend = (avg7 - avgPrev7).toFixed(1);
        const trendSymbol = weekTrend > 0 ? "+" : "";
        const trendClass = weekTrend > 0 ? "trend-positive" : "trend-negative";
        
        statsHTML += `<br><strong>Week-over-Week:</strong> <span class="${trendClass}">${trendSymbol}${weekTrend} lbs</span>`;
      }

      document.getElementById("graphStats").innerHTML = statsHTML;
    }

    function closeWeightModal() {
      document.getElementById("weightModal").style.display = "none";
    }

    function closeModalOnOutsideClick(event) {
      const modal = document.getElementById("weightModal");
      if (event.target === modal) {
        closeWeightModal();
      }
    }

    function addIntake() {
      const addButton = document.getElementById("addButton");

      // Disable button temporarily
      addButton.disabled = true;
      addButton.classList.add("disabled");

      setTimeout(() => {
        addButton.disabled = false;
        addButton.classList.remove("disabled");
      }, 2500);

      totals.calories += Number(document.getElementById("addCalories").value) || 0;
      totals.protein += Number(document.getElementById("addProtein").value) || 0;
      totals.carbs += Number(document.getElementById("addCarbs").value) || 0;
      totals.fat += Number(document.getElementById("addFat").value) || 0;

      saveTotals();
      updateDisplay();
    }

    function addHydration(amount) {
      totals.hydration += amount;
      saveTotals();
      updateDisplay();
    }

    function recordMeds() {
      const now = new Date();
      medsTimestamp = now.toLocaleString();
      localStorage.setItem("medsTimestamp", medsTimestamp);
      document.getElementById("medsTimestamp").innerText = `Last taken: ${medsTimestamp}`;
    }

    function confirmResetTotals() {
      if (confirm("Reset today's totals?")) resetTotals();
    }

    function confirmResetEverything() {
      if (confirm("Reset ALL data (totals + targets)? Weight log will be preserved.")) resetEverything();
    }

    function resetTotals() {
      totals = { calories: 0, protein: 0, carbs: 0, fat: 0, hydration: 0 };
      localStorage.setItem("macroTotals", JSON.stringify(totals));
      updateDisplay();
    }

    function resetEverything() {
      totals = { calories: 0, protein: 0, carbs: 0, fat: 0, hydration: 0 };
      targets = { calories: "", protein: "", carbs: "", fat: "", hydration: "" };

      localStorage.removeItem("macroTotals");
      localStorage.removeItem("macroTargets");

      document.getElementById("targetCalories").value = "";
      document.getElementById("targetProtein").value = "";
      document.getElementById("targetCarbs").value = "";
      document.getElementById("targetFat").value = "";
      document.getElementById("targetHydration").value = "";

      updateDisplay();
    }

    document.addEventListener("DOMContentLoaded", loadData);
  </script>

</body>
</html>
